name: Update from upstream and Publish Firefox Extension

on:
  # 定时触发（每天检查一次）
  schedule:
    - cron: '0 0 * * *'
  # 手动触发
  workflow_dispatch:
  # 如果可以配置webhook，也可以在upstream仓库更新时触发

jobs:
  update-and-publish:
    runs-on: ubuntu-latest
    environment: production  # 指定使用名为production的环境及其secrets
    steps:
      # 检出代码
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true  # 确保凭证在后续步骤中可用

      # 设置Git配置
      - name: Configure Git
        run: |
          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'
          # 添加upstream远程仓库
          git remote add upstream https://github.com/siyuan-note/siyuan-chrome.git || true
          git fetch upstream

      # 保存当前版本号
      - name: Save current version
        id: current_version
        run: |
          # 从manifest.json提取版本号
          VERSION=$(grep -o '"version": "[^"]*"' manifest.json | cut -d '"' -f 4)
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT
          echo "当前版本: $VERSION"

      # 拉取并合并upstream代码
      - name: Pull and merge from upstream
        run: |
          # 切换到main分支
          git checkout main
          # 设置默认合并策略
          git config pull.rebase false
          # 拉取upstream代码
          git pull upstream main -X theirs --no-edit

      # 转换Chrome API为Firefox API
      - name: Convert Chrome API to Firefox API
        run: |
          # 执行类似我们脚本中的API转换逻辑
          find . -type f -name "*.js" -not -path "*/node_modules/*" -not -path "*/\.*" | while read file; do
            echo "处理文件: $file"
            # 替换chrome API为browser API
            sed -i 's/chrome\./browser\./g' "$file"
          done

      # 检查版本号是否变化
      - name: Check for version change
        id: version_check
        run: |
          # 从更新后的manifest.json提取版本号
          NEW_VERSION=$(grep -o '"version": "[^"]*"' manifest.json | cut -d '"' -f 4)
          echo "新的版本: $NEW_VERSION"
          
          # 比较版本号
          if [ "${{ steps.current_version.outputs.current_version }}" != "$NEW_VERSION" ]; then
            echo "版本已更新！"
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          else
            echo "版本未变化。"
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

      # 提交并推送更改
      - name: Commit and push changes
        run: |
          # 检查当前工作目录状态（调试信息）
          echo "当前工作目录内容："
          ls -la
          
          # 显示git状态（调试信息）
          echo "Git状态："
          git status
          
          # 检查是否有未推送的提交
          if git log origin/main..HEAD --oneline; then
            echo "发现有未推送的提交，尝试直接推送..."
            # 直接推送已存在的提交
            git push origin main -f
            echo "已成功推送所有未推送的提交。"
          else
            # 检查是否有未提交的更改
            if [ -n "$(git status --porcelain)" ]; then
              echo "发现未提交的更改，准备提交..."
              # 添加所有更改
              git add .
              # 强制添加manifest.json（确保版本更新被捕获）
              git add manifest.json
              # 提交更改
              git commit -m "自动提交：从upstream拉取代码并转换chrome API为browser API"
              echo "准备推送更改..."
              git push origin main -f
              echo "更改已成功推送到仓库。"
            else
              echo "没有未提交的更改，工作树干净。"
              # 尝试直接推送（即使显示没有更改，也可能是因为更改已经被提交但未推送）
              echo "尝试直接推送，确保所有更改都已推送到远程..."
              git push origin main -f
            fi
          fi
          
          # 显示最终状态（调试信息）
          echo "最终Git状态："
          git status
      
      # 安装Firefox扩展打包工具
      - name: Install web-ext
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          npm install --global web-ext

      # 打包Firefox扩展
      - name: Build Firefox extension
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          web-ext build --no-input
          echo "打包完成，扩展文件位于web-ext-artifacts/目录"

      # 发布到Firefox Add-ons Store
      - name: Publish to Firefox Add-ons
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          echo "将使用Mozilla Add-ons API发布扩展..."
          # 注意：需要设置Mozilla Add-ons API密钥和密码
          web-ext sign --api-key ${{ secrets.MOZILLA_API_KEY }} --api-secret ${{ secrets.MOZILLA_API_SECRET }} --channel listed
        env:
          NODE_ENV: production